<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acaex API Initializr Project Setup</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
  <style>
    /* Estilos adicionales para el checkbox */
    .checkbox-container {
      display: flex;
      align-items: center;
      padding:20px;
    }
    .checkbox-container input {
      margin-right: 10px;
    }
  </style>
</head>

<body>
  <main class="container">

    <h1>Acaex API Initializr Project Setup</h1>
    <form id="projectForm">
      <label for="appName">Nombre de la Aplicacion(minúsculas y sin espacios):</label>
      <input type="text" id="appName" name="appName" value="demo" required>
      <div class="checkbox-container">
        <input type="checkbox" id="addTestData" name="addTestData">
        <label for="addTestData">Añadir datos de prueba</label>
      </div>
      <button type="submit">Generar Proyecto</button>
    </form>
    <a id="downloadLink" style="display:none;">Download Project</a>
  </main>
  <script>

    document.getElementById('projectForm').addEventListener('submit', async (event) => {
      event.preventDefault();

      const appName = document.getElementById('appName').value;
      const addTestData = document.getElementById('addTestData').checked;
      console.log(appName, addTestData)

      const zipBlob = await downloadSpringbootInitializr(appName)
      const zip = await unzip(zipBlob)
      const projectFolder = await unzippedProjectFolder(zip, appName)

      handleResourcesFolder(projectFolder, appName)
      addAppController(projectFolder, appName)
      projectFolder.file('pom.xml', modifiedPom(projectFolder, appName));
      projectFolder.file('.versionrc', generateVersionRc())
      projectFolder.file('.env.properties.example', getEnvPropertiesExample())
      projectFolder.file('.gitlab-ci.yml', getGitlabCiFileContent())
      projectFolder.file('.gitignore', (await projectFolder.file('.gitignore').async('string')).replace(".vscode/", "") + "\n.env.properties" + "\n*.db")
      projectFolder.folder(`src/main/java/es/acaex/${appName}/services`)
      projectFolder.folder(`src/main/java/es/acaex/${appName}/models`)
      projectFolder.folder(`src/main/java/es/acaex/${appName}/models/mappers`)
      projectFolder.folder(`src/main/java/es/acaex/${appName}/repositories`)
      projectFolder.folder(`src/main/java/es/acaex/${appName}/controllers`)
      addVsCodeFolder(projectFolder, appName)
      addScriptsFolder(projectFolder)

      if(addTestData) {
        addWholeExampleofData(projectFolder, appName)
      }

      // Re-comprimir el proyecto modificado
      const newZipBlob = await zip.generateAsync({ type: 'blob' });

      forceDownload(newZipBlob, appName)

    });

    function addWholeExampleofData(projectFolder, appName) {
      projectFolder.file(`src/main/resources/db/migration/common/V1_0_1__consejerias_insert_data.sql`, getFlywayData())
      projectFolder.file(`src/main/resources/db/migration/h2/V1_0_0__consejerias_create_table.sql`, getFlywayH2Table())
      projectFolder.file(`src/main/resources/db/migration/oracle/V1_0_0__consejerias_create_table.sql`, getFlywayOracleTable())
      projectFolder.file(`src/main/java/es/acaex/${appName}/models/Consejeria.java`, getConsejeriaEntity(appName))
      projectFolder.file(`src/main/java/es/acaex/${appName}/repositories/ConsejeriasRepository.java`, getConsejeriaRepository(appName))
      projectFolder.file(`src/main/java/es/acaex/${appName}/controllers/ConsejeriasController.java`, getConsejeriaController(appName))
      projectFolder.file(`src/main/java/es/acaex/${appName}/services/consejerias/FindAllConsejeriaService.java`, getConsejeriasService(appName))
    }

    function generateVersionRc() {
      return JSON.stringify({
        "bumpFiles": [
          {
            "filename": "pom.xml"
          }
        ],
        "packageFiles": [
          {
            "filename": "pom.xml"
          }
        ],
        "header": "# Versiones\n\nTodos los cambios relevantes relativos al proyecto estarán aquí documentados.\n",
        "commitUrlFormat": "https://gitlab.com/tu-usuario/tu-repositorio/commit/{{hash}}",
        "compareUrlFormat": "../../compare/{{previousTag}}...{{currentTag}}",
        "issueUrlFormat": "../../issues/{{id}}",
        "types": [
          {
            "type": "feat",
            "section": "Funcionalidades"
          },
          {
            "type": "fix",
            "section": "Errores Corregidos"
          },
          {
            "type": "test",
            "section": "Tests",
            "hidden": true
          },
          {
            "type": "build",
            "section": "Sistema de Build",
            "hidden": true
          },
          {
            "type": "ci",
            "hidden": true
          }
        ]
      }, null, 2)
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    async function getBlobFromLocalStorageOrFetch(key, url) {
      // Comprueba si el blob ya está en localStorage
      const savedBlob = localStorage.getItem(key);
      if (savedBlob) {
        // Convierte el string base64 a un blob
        const response = await fetch(savedBlob);
        console.log("Blob from cache")
        return await response.blob();
      }

      // Si no está en localStorage, realiza el fetch
      const response = await fetch(url);
      const blob = await response.blob();

      // Convierte el blob a base64 y guárdalo en localStorage
      const base64Blob = await blobToBase64(blob);
      localStorage.setItem(key, base64Blob);
      console.log("Blob from fetch")
      return blob;
    }

    function addAppController(projectFolder, appName) {
      const controllersFolder = projectFolder
        .folder('src')
        .folder('main')
        .folder('java')
        .folder('es')
        .folder('acaex')
        .folder(appName)
        .folder('controllers');

      controllersFolder.file('AppController.java', getAppControllerFileContent(appName));
    }

    function handleResourcesFolder(projectFolder, appName) {
      const propertiesContent = "spring.config.import=file:.env.properties" + "\n" +
        "app.version=local-dev" + "\n" +
        "app.path.logs=.path/logs" + "\n" +
        "app.env=local" + "\n"

      const resourcesFolder = projectFolder.folder('src').folder('main').folder('resources');
      resourcesFolder.file('application.properties', propertiesContent);
      resourcesFolder.file('logback-spring.xml', getLogbackFileContent(appName));
      resourcesFolder.file('openapi.yml', getOpenApiSpecificatioExample(appName))

    }

    function forceDownload(newZipBlob, appName) {
      // Crear un enlace de descarga
      const downloadLink = document.getElementById('downloadLink');
      downloadLink.href = URL.createObjectURL(newZipBlob);
      downloadLink.download = `${appName}.zip`;
      downloadLink.style.display = 'none';
      downloadLink.textContent = 'Download Project';
      downloadLink.click();
    }

    async function downloadSpringbootInitializr(appName) {
      // https://stackoverflow.com/questions/6566456/how-to-serialize-an-object-into-a-list-of-url-query-parameters
      const options = {
        type: "maven-project",
        language: "java",
        bootVersion: "3.3.0",
        baseDir: appName,
        groupId: "es.acaex",
        artifactId: appName,
        description: "Acaex Initializr for " + appName,
        packageName: "es.acaex." + appName,
        packaging: "war",
        javaVersion: 17,
        dependencies: "lombok,h2,devtools,oracle,web,jpa,flyway"
      }
      // Descargar el proyecto desde Spring Initializr
      const searchParams = new URLSearchParams(options).toString();
      console.log(`https://start.spring.io/starter.zip?${searchParams}`)
      const url = 'https://corsproxy.io/?' + encodeURIComponent(`https://start.spring.io/starter.zip?${searchParams}`);
      // const response = await fetch(url)
      // console.log(response);
      // const blob = await response.blob();
      const blob = await getBlobFromLocalStorageOrFetch(appName, url)
      console.log(blob)
      return blob
    }

    async function unzip(blob) {
      return await JSZip.loadAsync(blob);
    }

    async function unzippedProjectFolder(zip, appName) {
      return zip.folder(appName);
    }

    async function modifiedPom(projectFolder, appName) {
      console.log(projectFolder)
      // Modificar el archivo pom.xml
      const pomXml = await projectFolder.file('pom.xml').async('string');
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(pomXml, 'application/xml');

      const project = xmlDoc.getElementsByTagName('project')[0];
      let newProfiles = xmlDoc.createElementNS(project.namespaceURI, 'profiles');
      newProfiles.innerHTML = `
                <profile>
                    <id>dev</id>
                    <build>
                        <directory>\${directory}/\${finalName}</directory>
                        <finalName>\${finalName}</finalName>
                    </build>
                </profile>
            `;
      project.appendChild(newProfiles);

      let newRepositories = xmlDoc.createElementNS(project.namespaceURI, 'repositories');
      newRepositories.innerHTML = `
                <repository>
			            <id>gitlab-maven</id>
			            <url>https://gitlab.acaex.es/api/v4/projects/1068/packages/maven</url>
		            </repository>
	              
            `;
      project.appendChild(newRepositories);

      const properties = xmlDoc.getElementsByTagName('properties')[0];
      console.log(properties)
      properties.innerHTML = `<java.version>17</java.version>` + "\n" +
        `<finalName>${appName}</finalName>` + "\n" +
        `<directory>/var/data</directory>` + "\n" +
        `<org.mapstruct.version>1.5.5.Final</org.mapstruct.version>` + "\n" +
        `<org.projectlombok.version>1.18.32</org.projectlombok.version>` 

      // Aquí puedes hacer las modificaciones necesarias al pom.xml
      const dependencies = xmlDoc.getElementsByTagName('dependencies')[0];
      // https://stackoverflow.com/questions/13220095/remove-unwanted-empty-xmlns-attribute-added-by-appendchild
      let newDependency = xmlDoc.createElementNS(dependencies.namespaceURI, 'dependency');
      newDependency.innerHTML = `
                <groupId>org.springdoc</groupId>
                <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
                <version>2.3.0</version>
            `;
      dependencies.appendChild(newDependency);

      newDependency = xmlDoc.createElementNS(dependencies.namespaceURI, 'dependency');
      newDependency.innerHTML = `
                <groupId>javax.validation</groupId>
                <artifactId>validation-api</artifactId>
                <version>2.0.1.Final</version>
            `;
      dependencies.appendChild(newDependency);

      newDependency = xmlDoc.createElementNS(dependencies.namespaceURI, 'dependency');
      newDependency.innerHTML = `
                <groupId>org.openapitools</groupId>
                <artifactId>jackson-databind-nullable</artifactId>
                <version>0.2.6</version>
            `;
      dependencies.appendChild(newDependency);

      newDependency = xmlDoc.createElementNS(dependencies.namespaceURI, 'dependency');
      newDependency.innerHTML = `
                <groupId>javax.annotation</groupId>
                <artifactId>javax.annotation-api</artifactId>
                <version>1.3.2</version>
            `;
      dependencies.appendChild(newDependency);

      newDependency = xmlDoc.createElementNS(dependencies.namespaceURI, 'dependency');
      newDependency.innerHTML = `
                <groupId>javax.servlet</groupId>
                <artifactId>servlet-api</artifactId>
                <version>2.5</version>
                <scope>provided</scope>
            `;
      dependencies.appendChild(newDependency);

      newDependency = xmlDoc.createElementNS(dependencies.namespaceURI, 'dependency');
      newDependency.innerHTML = `
                <groupId>org.mapstruct</groupId>
                <artifactId>mapstruct</artifactId>
                <version>\${org.mapstruct.version}</version>
                <scope>provided</scope>
            `;
      dependencies.appendChild(newDependency);

      newDependency = xmlDoc.createElementNS(dependencies.namespaceURI, 'dependency');
      newDependency.innerHTML = `
                <groupId>es.acaex</groupId>
                <artifactId>jwt_visado</artifactId>
                <version>0.2.2</version>
            `;
      dependencies.appendChild(newDependency);

      const plugins = xmlDoc.getElementsByTagName('plugins')[0];
      const newPlugin = xmlDoc.createElementNS(plugins.namespaceURI, 'plugin');
      newPlugin.innerHTML = `
            	<groupId>org.openapitools</groupId>
				<artifactId>openapi-generator-maven-plugin</artifactId>
				<version>7.5.0</version>
				<executions>
					<execution>
						<goals>
							<goal>generate</goal>
						</goals>
						<configuration>
							<inputSpec>\${project.basedir}/src/main/resources/openapi.yml</inputSpec>
							<generatorName>spring</generatorName>
							<apiPackage>es.acaex.${appName}.api</apiPackage>
							<modelPackage>es.acaex.${appName}.dto</modelPackage>
							<supportingFilesToGenerate>
								ApiUtil.java
							</supportingFilesToGenerate>
							<configOptions>
								<delegatePattern>true</delegatePattern>
								<serializableModel>true</serializableModel>
							</configOptions>
						</configuration>
					</execution>
				</executions>`
      plugins.appendChild(newPlugin);


      const newPlugin2 = xmlDoc.createElementNS(plugins.namespaceURI, 'plugin');
      newPlugin2.innerHTML = `
            	<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<version>3.8.1</version>
				<configuration>
					<source>1.8</source>
					<target>1.8</target>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
							<version>\${org.projectlombok.version}</version>
						</path>
						<path>
							<groupId>org.mapstruct</groupId>
							<artifactId>mapstruct-processor</artifactId>
							<version>\${org.mapstruct.version}</version>
						</path>

					</annotationProcessorPaths>
				</configuration>`
      plugins.appendChild(newPlugin2);

      console.log(xmlDoc)
      // Serializar el XML modificado
      const serializer = new XMLSerializer();
      const newPomXml = serializer.serializeToString(xmlDoc);
      //console.log(newPomXml)
      //projectFolder.file('pom.xml', newPomXml);
      // No me funciona si lo hago aqui dentro
      //projectFolder.file(appName + 'pom.xml', newPomXml);
      //projectFolder.file(appName + 'poma.xml', newPomXml);
      return newPomXml;
    }

    async function addVsCodeFolder(projectFolder, appName) {
      // Añadir archivos adicionales
      const vscodeFolder = projectFolder.folder('.vscode');
      vscodeFolder.file('tasks.json', JSON.stringify({
        "version": "2.0.0",
        "tasks": [
          {
            "label": "setup_environment",
            "type": "shell",
            "command": "./scripts/setup.bat",
            "runOptions": {
              "runOn": "folderOpen"
            },
            "problemMatcher": []
          },
          {
            "label": "spring_boot_run",
            "type": "shell",
            "command": ".\\mvnw clean spring-boot:run",
            "problemMatcher": []
          },
          {
            "label": "bump_version",
            "type": "shell",
            "command": "if (Get-Command commit-and-tag-version -ErrorAction SilentlyContinue) { commit-and-tag-version } else { Write-Host 'commit-and-tag-version no está instalado en el sistema.' }",
            "problemMatcher": []
          },
          {
            "label": "commit",
            "type": "shell",
            "command": "${command:extension.conventionalCommits}",
            "problemMatcher": []
          }
        ],
      }, null, 2));

      vscodeFolder.file('settings.json', JSON.stringify({
        "VsCodeTaskButtons.showCounter": false,
        "VsCodeTaskButtons.tasks": [
          {
            "label": "$(testing-run-icon) Spring-Boot:Run",
            "task": "spring_boot_run",
            "tooltip": "Ejecutar mvn spring-boot:run."
          },
          {
            "label": "$(versions) Nueva Versión",
            "task": "bump_version",
            "tooltip": "Tarea para aumentar de version y etiquetar en git correctamente."
          },
          {
            "label": "$(git-commit) Nuevo Commit",
            "task": "commit",
            "tooltip": "Tarea para generar mensaje de commit."
          }
        ],
        "java.compile.nullAnalysis.mode": "automatic"
      }, null, 2));

      vscodeFolder.file('extensions.json', JSON.stringify({
        "recommendations": [
          "vscjava.vscode-java-pack",
          "vmware.vscode-boot-dev-pack",
          "vscode-icons-team.vscode-icons",
          "spencerwmiles.vscode-task-buttons",
          "vivaxy.vscode-conventional-commits"
        ]
      }, null, 2));

      vscodeFolder.file('acaex.code-snippets', JSON.stringify({
        // Place your global snippets here. Each snippet is defined under a snippet name and has a scope, prefix, body and 
        // description. Add comma separated ids of the languages where the snippet is applicable in the scope field. If scope 
        // is left empty or omitted, the snippet gets applied to all languages. The prefix is what is 
        // used to trigger the snippet and the body will be expanded and inserted. Possible variables are: 
        // $1, $2 for tab stops, $0 for the final cursor position, and ${1:label}, ${2:another} for placeholders. 
        // Placeholders with the same ids are connected.
        // Example:
        // "Print to console": {
        // 	"scope": "javascript,typescript",
        // 	"prefix": "log",
        // 	"body": [
        // 		"console.log('$1');",
        // 		"$2"
        // 	],
        // 	"description": "Log output to console"
        // }
        "Entity": {
          "scope": "java",
          "prefix": "jex-entity",
          "body": [
            "import jakarta.persistence.Entity;",
            "import jakarta.persistence.GeneratedValue;",
            "import jakarta.persistence.GenerationType;",
            "import jakarta.persistence.Id;",
            "import lombok.AllArgsConstructor;",
            "import lombok.Builder;",
            "import lombok.Data;",
            "import lombok.NoArgsConstructor;",
            "",
            "@Entity(name = \"$2\")\t",
            "@Data  ",
            "@Builder",
            "@AllArgsConstructor",
            "@NoArgsConstructor",
            "public class $1 {",
            "",
            "\t@Id",
            "\t@GeneratedValue(strategy = GenerationType.IDENTITY)",
            "\tprivate Long id;",
            "",
            "\tprivate String nombre;",
            "}"
          ]
        },
        "EntitiesRepository": {
          "scope": "java",
          "prefix": "jex-repository",
          "body": [
            "import org.springframework.data.jpa.repository.JpaRepository;",
            "import es.acaex." + appName + ".models.$2;",
            "",
            "public interface $1 extends JpaRepository<$2, Long> {",
            "\t",
            "}"
          ]
        },
        "openapi-endpoint": {
          "scope": "yaml",
          "prefix": "ex-openapi-endpoint",
          "body": [
            "/$1:",
            "\tget:",
            "\t\tsummary: Listado de $2 en la aplicación",
            "\t\toperationId: listar$2",
            "\t\ttags:",
            "\t\t- $1",
            "\t\tresponses:",
            "\t\t\t\"200\":",
            "\t\t\t\tdescription: Listado completo de $2",
            "\t\t\t\tcontent:",
            "\t\t\t\t\tapplication/json:",
            "\t\t\t\t\t\tschema:",
            "\t\t\t\t\t\t\t\\$ref: \"#/components/schemas/$2ListResponse\"",
            "\t\t\t\"401\":",
            "\t\t\t\tdescription: El usuario no está autenticado",
            "\t\t\t\tcontent:",
            "\t\t\t\t\tapplication/json:",
            "\t\t\t\t\t\tschema:",
            "\t\t\t\t\t\t\t\\$ref: \"#/components/schemas/NoAuthError\"",
            "\t\t\t\"403\":",
            "\t\t\t\tdescription: El usuario no tiene permisos para acceder a este recurso",
            "\t\t\t\tcontent:",
            "\t\t\t\t\tapplication/json:",
            "\t\t\t\t\t\tschema:",
            "\t\t\t\t\t\t\t\\$ref: \"#/components/schemas/NoAuthError\"",
            "\tpost:",
            "\t\tsummary: Crear $3",
            "\t\toperationId: crear$3",
            "\t\ttags:",
            "\t\t- $1",
            "\t\trequestBody:",
            "\t\t\tdescription: Crear una nueva $3 en la Aplicación",
            "\t\t\tcontent:",
            "\t\t\t\tapplication/json:",
            "\t\t\t\t\tschema:",
            "\t\t\t\t\t\t\\$ref: \"#/components/schemas/$3Create\"",
            "\t\tresponses:",
            "\t\t\t\"201\":",
            "\t\t\t\tdescription: Consejería creada correctamente",
            "\t\t\t\tcontent:",
            "\t\t\t\t\tapplication/json:",
            "\t\t\t\t\t\tschema:",
            "\t\t\t\t\t\t\t\\$ref: \"#/components/schemas/$3DetailResponse\"",
            "\t\t\t\"400\":",
            "\t\t\t\tdescription: La información ofrecida es incorrecta",
            "\t\t\t\tcontent:",
            "\t\t\t\t\tapplication/json:",
            "\t\t\t\t\t\tschema:",
            "\t\t\t\t\t\t\t\\$ref: \"#/components/schemas/ErrorObject\"",
            "\t\t\t\"401\":",
            "\t\t\t\tdescription: El usuario no está autenticado",
            "\t\t\t\tcontent:",
            "\t\t\t\t\tapplication/json:",
            "\t\t\t\t\t\tschema:",
            "\t\t\t\t\t\t\t\\$ref: \"#/components/schemas/NoAuthError\"",
            "\t\t\t\"403\":",
            "\t\t\t\tdescription: El usuario no tiene permisos para acceder a este recurso",
            "\t\t\t\tcontent:",
            "\t\t\t\t\tapplication/json:",
            "\t\t\t\t\t\tschema:",
            "\t\t\t\t\t\t\t\\$ref: \"#/components/schemas/NoAuthError\""
          ]
        },
        "openApiEntitySchemas": {
          "scope": "yaml",
          "prefix": "ex-openapi-schemas",
          "body": [
            "${1:Plural}ListResponse:",
            "\ttype: object",
            "\tproperties:",
            "\t\tdata:",
            "\t\t\ttype: array",
            "\t\t\titems:",
            "\t\t\t\t\\$ref: \"#/components/schemas/${2:Singular}Summary\"",
            "$2DetailResponse:",
            "\ttype: object",
            "\tproperties:",
            "\t\tdata:",
            "\t\t\t\\$ref: \"#/components/schemas/$2Detail\"",
            "$2Summary:",
            "\ttype: object",
            "\trequired:",
            "\t\t- id",
            "\t\t- nombre",
            "\tproperties:",
            "\t\tid:",
            "\t\t\ttype: integer",
            "\t\t\tformat: int64",
            "\t\tnombre:",
            "\t\t\ttype: string",
            "$2Detail:",
            "\ttype: object",
            "\trequired:",
            "\t\t- id",
            "\t\t- nombre",
            "\tproperties:",
            "\t\tid:",
            "\t\t\ttype: integer",
            "\t\t\tformat: int64",
            "\t\tnombre:",
            "\t\t\ttype: string",
            "$2Create:",
            "\ttype: object",
            "\trequired:",
            "\t\t- nombre",
            "\tproperties:",
            "\t\tnombre:",
            "\t\t\ttype: string",
            "\t\t\tminLength: 1",
            "\t\t\tmaxLength: 60"
          ]
        },
      }))
    }

    async function addScriptsFolder(projectFolder) {
      const scriptsFolder = projectFolder.folder('scripts');
      scriptsFolder.file('setup.bat', getSetupScriptContent(), { unixPermissions: "755" });
    }

    function getSetupScriptContent() {
      return `@echo off
setlocal

REM Comprueba si .env.properties existe
if not exist ".env.properties" (
    if exist ".env.properties.example" (
        echo Creando .env.properties a partir de .env.properties.example...
        copy ".env.properties.example" ".env.properties"
        if %errorlevel% neq 0 (
            echo Error al copiar .env.properties.example a .env.properties.
            exit /b 1
        )
    ) else (
        echo .env.properties.example no existe. No se puede crear .env.properties.
        exit /b 1
    )
)

REM Comprueba si el comando commit-and-tag-version está instalado
where commit-and-tag-version >nul 2>&1
if %errorlevel% neq 0 (
    REM Comprueba si Node.js esta instalado
    where node >nul 2>&1
    if %errorlevel% neq 0 (
        echo Node.js no esta instalado. Por favor, instala Node.js primero.
        exit /b 1
    ) else (
        echo Instalando commit-and-tag-version...
        npm install -g commit-and-tag-version
        if %errorlevel% neq 0 (
            echo Error al instalar commit-and-tag-version.
            exit /b 1
        )
    )
)

REM Comprueba si el directorio actual es un repositorio de git
if not exist ".git" (
    echo Inicializando un nuevo repositorio Git...
    git init --initial-branch=desarrollo
    if %errorlevel% neq 0 (
        echo Error al inicializar el repositorio Git.
        exit /b 1
    )
    git add -A
    git commit -am "feat: Acaex API Initializr - Inicio de Proyecto"
    if %errorlevel% neq 0 (
        echo Error al hacer el primer commit.
        exit /b 1
    )
    
    REM Crear la primera versión
    echo Creando la primera version con commit-and-tag-version...
    commit-and-tag-version --release-as 0.1.0
    if %errorlevel% neq 0 (
        echo Error al crear la primera versión.
        exit /b 1
    )
)

echo Setup completado.
endlocal
exit /b 0`

    }

    function getLogbackFileContent(appName) {
      return `<?xml version="1.0" encoding="UTF-8"?>
<configuration debug="false">

	<property resource="application.properties" />

	<appender name="Console" class="ch.qos.logback.core.ConsoleAppender">
		<layout class="ch.qos.logback.classic.PatternLayout">
			<Pattern>
				%-5p|%date{ISO8601}|%X{Slf4jMDCFilter.UUID}|%logger{0}|%m%ex%n
			</Pattern>
		</layout>
	</appender>


	<appender name="RollingFile"
		class="ch.qos.logback.core.rolling.RollingFileAppender">
		<file>\${app.path.logs}/app-logger.log</file>
		<encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
			<Pattern>
				%-5p|%date{ISO8601}|%X{Slf4jMDCFilter.UUID}|%logger{0}|%m%ex%n
			</Pattern>
		</encoder>

		<rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
			<fileNamePattern>\${app.path.logs}/${appName}-logger-%d{yyyy-MM-dd}.%i.log
			</fileNamePattern>
			<timeBasedFileNamingAndTriggeringPolicy
				class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
				<maxFileSize>10MB</maxFileSize>
			</timeBasedFileNamingAndTriggeringPolicy>
		</rollingPolicy>
	</appender>

	<logger name="org.springframework.web.method.HandlerMethod">
		<level value="TRACE" />
	</logger>


	<root level="info">
		<appender-ref ref="RollingFile" />
	</root>
</configuration>`
    }

    function getAppControllerFileContent(appName) {
      return `package es.acaex.${appName}.controllers;

            import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.Map;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.ClassPathResource;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping
public class AppController {
    
    @Value("\${app.env}")
    private String appEnv;

    @Value("\${app.version}")
    private String appVersion;

    @GetMapping
    public Map<String, String> info() {
        return new HashMap<String, String>() {{
            put("Entorno", appEnv);
            put("Version", appVersion);
        }};
    }

    @GetMapping(value = "openapi.yml", produces = "application/yaml;charset=UTF-8")
    public ResponseEntity<String> openapiYaml() {
        return ResponseEntity.ok(getOpenApiYaml());
    }

    private String getOpenApiYaml(){
        String contenido = "no Content";
        ClassPathResource resource = new ClassPathResource("openapi.yml");
        
        try {
            InputStream inputStream = resource.getInputStream();
            contenido = new BufferedReader(
                new InputStreamReader(inputStream, StandardCharsets.UTF_8))
                    .lines()
                    .collect(Collectors.joining("\\n")
            );
        } catch (IOException e) {
            contenido = "IOException";
        }
        return contenido;
    }

}`
    }

    function getGitlabCiFileContent() {
      return `stages:
  - test
  - build
  - deploy

image: maven:3.8.3-openjdk-17

# Definimos Variables Generales y por entorno en función de la branch
before_script:
  - export SAST_JAVA_VERSION=11
  - export SECURE_LOG_LEVEL="debug"
  # Las siguientes líneas no hacen falta pero clarifican y verbalizan las variables que se usan durante los diferentes procesos
  - export APPNAME=$APPNAME
  - export INTEGRATION_USER=$INTEGRATION_USER
  - export WEBLOGIC_USER=$WEBLOGIC_USER
  - export WEBLOGIC_PASS=$WEBLOGIC_PASS
  # Variables por rama [desarrollo,preproduccion]
  - echo $CI_COMMIT_REF_NAME
  - |
      if [ "$CI_COMMIT_REF_NAME" = "desarrollo" ]; then
        export DEPLOY_SERVER=$SERVER_DES
        export WLPATH=$WLPATH_DES
        export CONFIGPATH=$CONFIGPATH_DES
        export SERVERNAME=$SERVERNAME_DES
        export LOGSPATH=$LOGSPATH_DES
        export OPENAPI_URL="https://despgapbackend.acaex.es/pgap_backend"
        echo "Definidas las variables de entorno desarrollo"
      elif [ "$CI_COMMIT_REF_NAME" = "preproduccion" ]; then
        export DEPLOY_SERVER=$SERVER_PRE
        export WLPATH=$WLPATH_PRE
        export CONFIGPATH=$CONFIGPATH_PRE
        export SERVERNAME=$SERVERNAME_PRE
        export LOGSPATH=$LOGSPATH_PRE
        export OPENAPI_URL="https://prupgapbackend.acaex.es/pgap_backend"
        echo "Definidas las variables de entorno preproduccion"
      else
        echo "Rama no contemplada"
      fi
  - echo $DEPLOY_SERVER
  - echo $WLPATH
  - echo $CONFIGPATH
  - echo $SERVERNAME
  - echo $LOGSPATH
  - |
    [ -z "$DEPLOY_SERVER" ] || [ -z "$WLPATH" ] || [ -z "$CONFIGPATH" ] || [ -z "$SERVERNAME" ] || [ -z "$LOGSPATH" ] && { echo "Error: Una o más variables están vacías."; exit 1; }



# Tests creados por el equipo para el proyecto
apptests:
  stage: test
  except:
    - tags
  tags:
    - springboot
  script:
    - mvn clean verify
  artifacts:
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml

include:
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml

# Para detectar posibles secretos que se hayan olvida en los archivos de la aplicación
secret_detection:
  tags:
    - springboot

# Tarea para construir el war, se genera el archivo application.properties a vuelo. 
build:
  stage: build
  except:
    - tags
  tags:
    - springboot
  script:    
    # Archivo externo de configuracion, versión y carpeta donde se alojarán los logs
    - echo "spring.config.import=file:\${CONFIGPATH}" > src/main/resources/application.properties
    - echo "app.version=$(git describe --tags --abbrev=0)" >> src/main/resources/application.properties
    - echo "app.path.logs=\${LOGSPATH}" >> src/main/resources/application.properties
    - echo "app.env=\${CI_COMMIT_REF_NAME}" >> src/main/resources/application.properties
    # Se muestra contenido en logs para posibles comprobaciones
    - cat src/main/resources/application.properties
    - mvn clean package -Pdev -Dmaven.test.skip=true -Ddirectory=/var/data/\${CI_COMMIT_REF_NAME}
    - ls -lah /var/data
    # Nos interesa tener esto en el log para buscar posibles incongruencias con dependencias en local
    # - mvn dependency:tree
   

# Despliegue en WebLogic 
deploy:
  stage: deploy
  except:
    - tags
  only:
    - desarrollo
    - preproduccion
  tags:
    - springboot
  script:
    # Gestion de credenciales SSH para que INTEGRATION_USER mande el war sin usar contraseña
    - 'which ssh-agent || ( apt-get install -qq openssh-client )'
    - eval $(ssh-agent -s)
    - echo \${SSH_PRIVATE_KEY} | base64 --decode | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh 
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    # Se borra todo lo que hay en carpeta actualizaciones
    - ssh $INTEGRATION_USER@$DEPLOY_SERVER "rm -rf /var/www/\${APPNAME}/actualizaciones/* && exit"
    # Creamos una carpeta con un timestamp sonde vamos a dejar el war
    - export COMMIT_TIME=$(git show -s --format=%ct $CI_COMMIT_SHA)
    - ssh $INTEGRATION_USER@$DEPLOY_SERVER "mkdir -p /var/www/\${APPNAME}/actualizaciones/$COMMIT_TIME && exit"
    # Copiamos el war en la carpeta creada antes
    - scp /var/data/$CI_COMMIT_REF_NAME/$APPNAME/$APPNAME.war $INTEGRATION_USER@$DEPLOY_SERVER:/var/www/\${APPNAME}/actualizaciones/$COMMIT_TIME/$APPNAME.war
    # Repligue de la version anterior
    - ssh $INTEGRATION_USER@$DEPLOY_SERVER "cd $WLPATH && /opt/jdk1.8.0_281/bin/java -cp weblogic.jar weblogic.Deployer -verbose -noexit -adminurl t3://$DEPLOY_SERVER:7001 -username $WEBLOGIC_USER -password $WEBLOGIC_PASS -targets \${SERVERNAME} -name $APPNAME -undeploy -timeout 300 && exit"
    # Nuevo despligue
    - ssh $INTEGRATION_USER@$DEPLOY_SERVER "cd $WLPATH && /opt/jdk1.8.0_281/bin/java -cp weblogic.jar weblogic.Deployer -verbose -noexit -adminurl t3://$DEPLOY_SERVER:7001 -username $WEBLOGIC_USER -password $WEBLOGIC_PASS -targets \${SERVERNAME} -source /var/www/\${APPNAME}/actualizaciones/$COMMIT_TIME/$APPNAME.war -stage -deploy -timeout 300 -name $APPNAME && exit"
  when: on_success
  needs: [build]`
    }

    function getEnvPropertiesExample() {
      return `# OpenAPI
springdoc.swagger-ui.url=/openapi.yml

# Base de Datos
spring.datasource.url=jdbc:h2:file:./database
spring.datasource.username=sa
spring.datasource.password=sa
spring.datasource.driver-class-name=org.h2.Driver

# No habilitar los metodos ddl-auto create o update con flyway.
# spring.jpa.hibernate.ddl-auto=update
# spring.flyway.enable=false

# Seleccionar las migraciones en función del driver de base de datos escogidos
spring.flyway.locations=classpath:db/migration/common,classpath:db/migration/h2
# spring.flyway.locations=classpath:db/migration/common,classpath:db/migration/oracle


# Jwt-Visado
jwt.environment=\${app.env}
cors.allowedOrigins=http://localhost:*,http://127.0.0.1:*
visado.area=
visado.aplicacion=
visado.entorno=
# visado.profileFallback=

# Alfresco Config
# alfresco.usuario=
# alfresco.pass=
# alfresco.url.login=https://desgdcorp.gobex.pri/alfresco/api/-default-/public/cmis/versions/1.1/browser
# alfresco.url.site=/Sitios/NOMBREPROYECTO/documentLibrary
# spring.servlet.multipart.enabled=true
# spring.servlet.multipart.max-file-size=10MB
# spring.servlet.multipart.max-request-size=10MB

# Email Config
# spring.mail.host=envios.gobex.pri
# spring.mail.port=25
# spring.mail.username=
# spring.mail.password=
# spring.mail.defaultEncoding=UTF-8
# spring.mail.properties.mail.smtp.auth=true
# spring.mail.properties.mail.smtp.timeout=20000
# spring.mail.properties.mail.smtp.starttls.enable=false
# spring.mail.properties.mail.debug=true
`
    }

    function getOpenApiSpecificatioExample(appName) {
      return `openapi: "3.0.0"
info:
  version: 0.1.0
  title: ${appName}
servers:
  - url: http://localhost:8080
    description: Servidor local de desarrollo
tags:
  - name: consejerias
    description: Consejerías de la Junta de Extremadura
paths:
  /consejerias:
    get:
      summary: Listado de Consejerías en la aplicación
      operationId: listarConsejerias
      tags:
        - consejerias
      responses:
        "200":
          description: Listado completo de consejerías
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConsejeriasListResponse"
        "401":
          description: El usuario no está autenticado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NoAuthError"
        "403":
          description: El usuario no tiene permisos para acceder a este recurso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NoAuthError"
    post:
      summary: Crear una nueva consejeria
      operationId: crearConsejeria
      tags:
        - consejerias
      requestBody:
        description: Crear una nueva consejeria en la Aplicación
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConsejeriaCreate"
      responses:
        "201":
          description: Consejería creada correctamente
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConsejeriaSummaryResponse"
        "400":
          description: La información ofrecida es incorrecta
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorObject"
        "401":
          description: El usuario no está autenticado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NoAuthError"
        "403":
          description: El usuario no tiene permisos para acceder a este recurso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NoAuthError"
components:
  securitySchemes:
    JWT:
      type: http
      scheme: bearer
      bearerFormat: JWT
    Profile:
      type: apiKey
      in: header
      name: Profile
    User:
      type: apiKey
      in: header
      name: Jwt-User
  schemas:
    NoAuthError:
      description: Cuando el usuario no está logueado(AUTHenticate) o no tiene permisos (AUTHorization)
      type: object
      properties:
        code:
          type: integer
        error:
          type: string
    ErrorMessage:
      type: object
      properties:
        code:
          type: integer
        error:
          type: string
    ErrorObject:
      type: object
      properties:
        code:
          type: integer
        error:
          type: object
          additionalProperties: true
          example:
            nombre: "No puede ser nulo"
            descripcion: "Longitud debe estar entre 1 y 2048"
    ConsejeriasListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/ConsejeriaSummary"
    ConsejeriaSummary:
      type: object
      required:
        - id
        - dir3
        - nombre
      properties:
        id:
          type: integer
          format: int64
        dir3:
          type: string
        nombre:
          type: string
    ConsejeriaCreate:
      type: object
      required:
        - nombre
        - dir3
      properties:
        dir3:
          type: string
          minLength: 1
        nombre:
          type: string
          minLength: 1
          maxLength: 60
    ConsejeriaSummaryResponse:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/ConsejeriaSummary"
    `;
    }
  
    function getFlywayData() {
        return `INSERT INTO "CONSEJERIAS" VALUES(1 , 'A11016094', 'Presidencia de la Junta de Extremadura');
INSERT INTO "CONSEJERIAS" VALUES(2 , 'A11005996', 'Consejería de Hacienda y Administración Pública');
INSERT INTO "CONSEJERIAS" VALUES(3 , 'A11044878', 'Consejería de Presidencia, Interior y Diálogo Social');
INSERT INTO "CONSEJERIAS" VALUES(4 , 'A11044880', 'Consejería de Agricultura, Ganadería y Desarrollo Sostenible');
INSERT INTO "CONSEJERIAS" VALUES(5 , 'A11044881', 'Consejería de Economía, Empleo y Transformación Digital');
INSERT INTO "CONSEJERIAS" VALUES(6 , 'A11044884', 'Consejería de Salud y Servicios Sociales');
INSERT INTO "CONSEJERIAS" VALUES(7 , 'A11044886', 'Consejería de Cultura, Turismo, Jóvenes y Deportes');
INSERT INTO "CONSEJERIAS" VALUES(8 , 'A11044887', 'Consejería de Educación, Ciencia y Formación Profesional');
INSERT INTO "CONSEJERIAS" VALUES(9 , 'A11044888', 'Consejería de Infraestructuras, Transporte y Vivienda');
INSERT INTO "CONSEJERIAS" VALUES(10, 'A11044889', 'Consejería de Gestión Forestal y Mundo Rural');`
    }

    function getFlywayH2Table(){
      return `CREATE TABLE IF NOT EXISTS CONSEJERIAS (
    ID int NOT NULL AUTO_INCREMENT,
    DIR3 varchar(255) NOT NULL,
    NOMBRE varchar(255),
    PRIMARY KEY (ID)
);`
    }

    function getFlywayOracleTable(){
      return `CREATE TABLE CONSEJERIAS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    DIR3 VARCHAR2(255),
    NOMBRE VARCHAR2(255)
);`
    }

    function getConsejeriaEntity(appName) {
      return `package es.acaex.${appName}.models;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity(name = "consejerias")	
@Data  
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Consejeria {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String dir3;
    private String nombre;
}`
    }
  
    function getConsejeriaRepository(appName) {
      return `package es.acaex.${appName}.repositories;

import org.springframework.data.jpa.repository.JpaRepository;
import es.acaex.${appName}.models.Consejeria;

public interface ConsejeriasRepository extends JpaRepository<Consejeria, Long> {
    
}`;
    }
  
    function getConsejeriasService(appName) {
      return `package es.acaex.${appName}.services.consejerias;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import es.acaex.${appName}.dto.ConsejeriaSummary;
import es.acaex.${appName}.dto.ConsejeriasListResponse;
import es.acaex.${appName}.models.Consejeria;
import es.acaex.${appName}.repositories.ConsejeriasRepository;

@Service
public class FindAllConsejeriaService {

    @Autowired ConsejeriasRepository consejeriasRepository;

    public ResponseEntity<ConsejeriasListResponse> response() {
        return ResponseEntity.ok().body(execute());
    }

    private ConsejeriasListResponse execute() {
        return new ConsejeriasListResponse()
            .data(consejeriasRepository.findAll().stream().map(this::consejeriaToConsejeriaSummary).toList())
        ;
    }

    private ConsejeriaSummary consejeriaToConsejeriaSummary(Consejeria consejeria){
        return new ConsejeriaSummary()
            .id(consejeria.getId())
            .dir3(consejeria.getDir3())
            .nombre(consejeria.getNombre())
        ;
    }
    
    
}
`;  
    }

    function getConsejeriaController(appName) {
      return `package es.acaex.${appName}.controllers;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Component;
import es.acaex.${appName}.api.ConsejeriasApiDelegate;
import es.acaex.${appName}.dto.ConsejeriasListResponse;
import es.acaex.${appName}.services.consejerias.FindAllConsejeriaService;

@Component

public class ConsejeriasController implements ConsejeriasApiDelegate{

    @Autowired FindAllConsejeriaService findAllConsejeriaService;

    @Override
    public ResponseEntity<ConsejeriasListResponse> listarConsejerias() {
        return findAllConsejeriaService.response();
    }
}
`;
    }
  </script>
</body>

</html>