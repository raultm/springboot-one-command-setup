<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acaex API Initializr Project Setup</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />

</head>

<body>
    <main class="container">

        <h1>Acaex API Initializr Project Setup</h1>
        <form id="projectForm">
            <label for="appName">Nombre de la Aplicacion(minúsculas y sin espacios):</label>
            <input type="text" id="appName" name="appName" value="demo" required>
            <button type="submit">Generar Proyecto</button>
        </form>
        <a id="downloadLink" style="display:none;">Download Project</a>
    </main>
    <script>

        document.getElementById('projectForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const appName = document.getElementById('appName').value;

            const zipBlob = await downloadSpringbootInitializr(appName)
            const zip = await unzip(zipBlob)
            const projectFolder = await unzippedProjectFolder(zip, appName)
            
            handleResourcesFolder(projectFolder, appName)
            addAppController(projectFolder, appName)
            projectFolder.file('pom.xml', modifiedPom(projectFolder, appName));
            addVsCodeFolder(projectFolder)

            // Re-comprimir el proyecto modificado
            const newZipBlob = await zip.generateAsync({ type: 'blob' });

            forceDownload(newZipBlob, appName)

        });

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        async function getBlobFromLocalStorageOrFetch(key, url) {
            // Comprueba si el blob ya está en localStorage
            const savedBlob = localStorage.getItem(key);
            if (savedBlob) {
                // Convierte el string base64 a un blob
                const response = await fetch(savedBlob);
                console.log("Blob from cache")
                return await response.blob();
            }

            // Si no está en localStorage, realiza el fetch
            const response = await fetch(url);
            const blob = await response.blob();

            // Convierte el blob a base64 y guárdalo en localStorage
            const base64Blob = await blobToBase64(blob);
            localStorage.setItem(key, base64Blob);
            console.log("Blob from fetch")
            return blob;
        }

        function addAppController(projectFolder, appName) {
            const controllersFolder = projectFolder
                .folder('src')
                .folder('main')
                .folder('java')
                .folder('es')
                .folder('acaex')
                .folder(appName)
                .folder('controllers');

            controllersFolder.file('AppController.java', getAppControllerFileContent(appName));
        }

        function handleResourcesFolder(projectFolder, appName) {
            const propertiesContent = "spring.config.import=file:.env.properties" + "\n" +
                "app.version=local-dev" + "\n" +
                "app.path.logs=.path/logs" + "\n" +
                "app.env=local" + "\n"

            const resourcesFolder = projectFolder.folder('src').folder('main').folder('resources');
            resourcesFolder.file('application.properties', propertiesContent);
            resourcesFolder.file('logback-spring.xml', getLogbackFileContent(appName));

        }

        function forceDownload(newZipBlob, appName) {
            // Crear un enlace de descarga
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = URL.createObjectURL(newZipBlob);
            downloadLink.download = `${appName}.zip`;
            downloadLink.style.display = 'none';
            downloadLink.textContent = 'Download Project';
            downloadLink.click();
        }

        async function downloadSpringbootInitializr(appName) {
            // https://stackoverflow.com/questions/6566456/how-to-serialize-an-object-into-a-list-of-url-query-parameters
            const options = {
                type: "maven-project",
                language: "java",
                bootVersion: "3.3.0",
                baseDir: appName,
                groupId: "es.acaex",
                artifactId: appName,
                description: "Acaex Initializr for " + appName,
                packageName: "es.acaex.es",
                packaging: "war",
                javaVersion: 17,
                dependencies: "lombok,h2,devtools,oracle,web"
            }
            // Descargar el proyecto desde Spring Initializr
            const searchParams = new URLSearchParams(options).toString();
            console.log(`https://start.spring.io/starter.zip?${searchParams}`)
            const url = 'https://corsproxy.io/?' + encodeURIComponent(`https://start.spring.io/starter.zip?${searchParams}`);
            // const response = await fetch(url)
            // console.log(response);
            // const blob = await response.blob();
            const blob = await getBlobFromLocalStorageOrFetch(appName, url)
            console.log(blob)
            return blob
        }

        async function unzip(blob) {
            return await JSZip.loadAsync(blob);
        }

        async function unzippedProjectFolder(zip, appName) {
            return zip.folder(appName);
        }

        async function modifiedPom(projectFolder, appName) {
            console.log(projectFolder)
            // Modificar el archivo pom.xml
            const pomXml = await projectFolder.file('pom.xml').async('string');
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(pomXml, 'application/xml');

            const properties = xmlDoc.getElementsByTagName('properties')[0];
            console.log(properties)
            properties.innerHTML = `<java.version>17</java.version>` + "\n" +
                `<finalName>${appName}</finalName>` + "\n" +
                `<directory>/var/data</directory>`

            // Aquí puedes hacer las modificaciones necesarias al pom.xml
            const dependencies = xmlDoc.getElementsByTagName('dependencies')[0];
            // https://stackoverflow.com/questions/13220095/remove-unwanted-empty-xmlns-attribute-added-by-appendchild
            const newDependency = xmlDoc.createElementNS(dependencies.namespaceURI, 'dependency');
            newDependency.innerHTML = `
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-thymeleaf</artifactId>
            `;
            dependencies.appendChild(newDependency);

            console.log(xmlDoc)
            // Serializar el XML modificado
            const serializer = new XMLSerializer();
            const newPomXml = serializer.serializeToString(xmlDoc);
            //console.log(newPomXml)
            //projectFolder.file('pom.xml', newPomXml);
            // No me funciona si lo hago aqui dentro
            //projectFolder.file(appName + 'pom.xml', newPomXml);
            //projectFolder.file(appName + 'poma.xml', newPomXml);
            return newPomXml;
        }

        async function addVsCodeFolder(projectFolder) {
            // Añadir archivos adicionales
            const vscodeFolder = projectFolder.folder('.vscode');
            vscodeFolder.file('launch.json', JSON.stringify({
                "version": "2.0.0",
                "tasks": [
                    {
                        "label": "setup_environment",
                        "type": "shell",
                        "command": "./.scripts/setup.sh",
                        "windows": {
                            "command": "bash .scripts/setup.sh"
                        },
                        "runOptions": {
                            "runOn": "folderOpen"
                        },
                        "problemMatcher": []
                    },
                    {
                        "label": "spring_boot_run",
                        "type": "shell",
                        "command": ".\\mvnw clean spring-boot:run",
                        "problemMatcher": []
                    },
                    {
                        "label": "bump_version",
                        "type": "shell",
                        "command": "./.scripts/bump_version.sh ${input:selectedVersion}",
                        "windows": {
                            "command": "$PSDefaultParameterValues['Out-File:Encoding'] = 'utf8'; bash .scripts/bump_version.sh ${input:selectedVersion}"
                        },
                        "problemMatcher": []
                    }
                ],
                "inputs": [
                    {
                        "type": "pickString",
                        "id": "selectedVersion",
                        "description": "¿qué tipo de versión está creando? \nPruba\nprueba",
                        "options": [
                            {
                                "label": "Parche - Nueva funcionalidad compatible con versiones anteriores o arreglo de error",
                                "value": "patch"
                            },
                            {
                                "label": "Mayor - Nueva funcionalidad incompatible con versiones anteriores.",
                                "value": "minor"
                            },
                            {
                                "label": "Mayor - Hito de Nueva Version.",
                                "value": "major"
                            }
                        ],
                        "default": "patch"
                    }
                ]
            }, null, 2));

            vscodeFolder.file('settings.json', JSON.stringify({
                "VsCodeTaskButtons.showCounter": true,
                "VsCodeTaskButtons.tasks": [
                    {
                        "label": "$(testing-run-icon) Spring-Boot:Run",
                        "task": "spring_boot_run",
                        "tooltip": "Ejecutar mvn spring-boot:run."
                    },
                    {
                        "label": "$(versions) Nueva Versión",
                        "task": "bump_version",
                        "tooltip": "Tarea para aumentar de version y etiquetar en git correctamente."
                    }
                ]
            }, null, 2));

            vscodeFolder.file('extensions.json', JSON.stringify({
                "recommendations": [
                    "vscjava.vscode-java-pack",
                    "vmware.vscode-boot-dev-pack",
                    "vscode-icons-team.vscode-icons",
                    "spencerwmiles.vscode-task-buttons"
                ]
            }, null, 2));
        }

        function getLogbackFileContent(appName) {
            return `<?xml version="1.0" encoding="UTF-8"?>
<configuration debug="false">

	<property resource="application.properties" />

	<appender name="Console" class="ch.qos.logback.core.ConsoleAppender">
		<layout class="ch.qos.logback.classic.PatternLayout">
			<Pattern>
				%-5p|%date{ISO8601}|%X{Slf4jMDCFilter.UUID}|%logger{0}|%m%ex%n
			</Pattern>
		</layout>
	</appender>


	<appender name="RollingFile"
		class="ch.qos.logback.core.rolling.RollingFileAppender">
		<file>\${app.path.logs}/app-logger.log</file>
		<encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
			<Pattern>
				%-5p|%date{ISO8601}|%X{Slf4jMDCFilter.UUID}|%logger{0}|%m%ex%n
			</Pattern>
		</encoder>

		<rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
			<fileNamePattern>\${app.path.logs}/${appName}-logger-%d{yyyy-MM-dd}.%i.log
			</fileNamePattern>
			<timeBasedFileNamingAndTriggeringPolicy
				class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
				<maxFileSize>10MB</maxFileSize>
			</timeBasedFileNamingAndTriggeringPolicy>
		</rollingPolicy>
	</appender>

	<logger name="org.springframework.web.method.HandlerMethod">
		<level value="TRACE" />
	</logger>


	<root level="info">
		<appender-ref ref="RollingFile" />
	</root>
</configuration>`
        }

        function getAppControllerFileContent(appName) {
            return `package es.acaex.${appName}.controllers;

import java.util.HashMap;
import java.util.Map;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping
public class AppController {
    
    @Value("\${app.env}")
    private String appEnv;

    @Value("\${app.version}")
    private String appVersion;

    @GetMapping
    public Map<String, String> info() {
        return new HashMap<String, String>() {{
            put("Entorno", appEnv);
            put("Version", appVersion);
        }};
    }
}`
        }
    </script>
</body>

</html>