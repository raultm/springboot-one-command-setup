<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acaex API Initializr Project Setup</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />

</head>

<body>
    <main class="container">

        <h1>Acaex API Initializr Project Setup</h1>
        <form id="projectForm">
            <label for="appName">Nombre de la Aplicacion(minúsculas y sin espacios):</label>
            <input type="text" id="appName" name="appName" value="demo" required>
            <button type="submit">Generar Proyecto</button>
        </form>
        <a id="downloadLink" style="display:none;">Download Project</a>
    </main>
    <script>

        document.getElementById('projectForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const appName = document.getElementById('appName').value;

            const zipBlob = await downloadSpringbootInitializr(appName)
            const zip = await unzip(zipBlob)
            const projectFolder = await unzippedProjectFolder(zip, appName)

            handleResourcesFolder(projectFolder, appName)
            addAppController(projectFolder, appName)
            projectFolder.file('pom.xml', modifiedPom(projectFolder, appName));
            projectFolder.file('.versionrc', generateVersionRc())
            projectFolder.file('.env.properties.example', getEnvPropertiesExample())
            projectFolder.folder(`src/main/java/es/acaex/${appName}/services`)
            projectFolder.folder(`src/main/java/es/acaex/${appName}/models`)
            projectFolder.folder(`src/main/java/es/acaex/${appName}/repositories`)
            // ¿Modificacion de .gitignore?
            /**
             * Script de setup 
             *      - flag para marcar que ya se ha realizado el setup y no ejecutarlo si lo tiene
             *      - si no está instalado el comando commit-and-tag-version y existe node
             *          - instalación de https://github.com/absolute-version/commit-and-tag-version
             *      - si no hay repositorio 
             *          - git init
             *          - git commit -am "feat: Acaex API Initializr - Inicio de Proyecto"
             *          - Crear primera version con `commit-and-tag-version --packageFiles pom.xml --bumpFiles pom.xml`
             *      - si no existe .env.properties
             *          - crearlo haciendo una copia de .env.properties.example
             *      
             * */

            addVsCodeFolder(projectFolder)
            addScriptsFolder(projectFolder)

            // Re-comprimir el proyecto modificado
            const newZipBlob = await zip.generateAsync({ type: 'blob' });

            forceDownload(newZipBlob, appName)

        });

        function generateVersionRc() {
            return JSON.stringify({
                "header": "# Changelog\n\nTodos los cambios relevantes relativos al proyecto estarán aquí documentados.",
                "types": [
                    { "type": "feat", "section": "Funcionalidades" },
                    { "type": "fix", "section": "Errores Corregidos" },
                    { "type": "test", "section": "Tests", "hidden": true },
                    { "type": "build", "section": "Sistema de Build", "hidden": true },
                    { "type": "ci", "hidden": true }
                ]
            }, null, 2)
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        async function getBlobFromLocalStorageOrFetch(key, url) {
            // Comprueba si el blob ya está en localStorage
            const savedBlob = localStorage.getItem(key);
            if (savedBlob) {
                // Convierte el string base64 a un blob
                const response = await fetch(savedBlob);
                console.log("Blob from cache")
                return await response.blob();
            }

            // Si no está en localStorage, realiza el fetch
            const response = await fetch(url);
            const blob = await response.blob();

            // Convierte el blob a base64 y guárdalo en localStorage
            const base64Blob = await blobToBase64(blob);
            localStorage.setItem(key, base64Blob);
            console.log("Blob from fetch")
            return blob;
        }

        function addAppController(projectFolder, appName) {
            const controllersFolder = projectFolder
                .folder('src')
                .folder('main')
                .folder('java')
                .folder('es')
                .folder('acaex')
                .folder(appName)
                .folder('controllers');

            controllersFolder.file('AppController.java', getAppControllerFileContent(appName));
        }

        function handleResourcesFolder(projectFolder, appName) {
            const propertiesContent = "spring.config.import=file:.env.properties" + "\n" +
                "app.version=local-dev" + "\n" +
                "app.path.logs=.path/logs" + "\n" +
                "app.env=local" + "\n"

            const resourcesFolder = projectFolder.folder('src').folder('main').folder('resources');
            resourcesFolder.file('application.properties', propertiesContent);
            resourcesFolder.file('logback-spring.xml', getLogbackFileContent(appName));
            resourcesFolder.file('openapi.yml', getOpenApiSpecificatioExample())

        }

        function forceDownload(newZipBlob, appName) {
            // Crear un enlace de descarga
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = URL.createObjectURL(newZipBlob);
            downloadLink.download = `${appName}.zip`;
            downloadLink.style.display = 'none';
            downloadLink.textContent = 'Download Project';
            downloadLink.click();
        }

        async function downloadSpringbootInitializr(appName) {
            // https://stackoverflow.com/questions/6566456/how-to-serialize-an-object-into-a-list-of-url-query-parameters
            const options = {
                type: "maven-project",
                language: "java",
                bootVersion: "3.3.0",
                baseDir: appName,
                groupId: "es.acaex",
                artifactId: appName,
                description: "Acaex Initializr for " + appName,
                packageName: "es.acaex."+appName,
                packaging: "war",
                javaVersion: 17,
                dependencies: "lombok,h2,devtools,oracle,web"
            }
            // Descargar el proyecto desde Spring Initializr
            const searchParams = new URLSearchParams(options).toString();
            console.log(`https://start.spring.io/starter.zip?${searchParams}`)
            const url = 'https://corsproxy.io/?' + encodeURIComponent(`https://start.spring.io/starter.zip?${searchParams}`);
            // const response = await fetch(url)
            // console.log(response);
            // const blob = await response.blob();
            const blob = await getBlobFromLocalStorageOrFetch(appName, url)
            console.log(blob)
            return blob
        }

        async function unzip(blob) {
            return await JSZip.loadAsync(blob);
        }

        async function unzippedProjectFolder(zip, appName) {
            return zip.folder(appName);
        }

        async function modifiedPom(projectFolder, appName) {
            console.log(projectFolder)
            // Modificar el archivo pom.xml
            const pomXml = await projectFolder.file('pom.xml').async('string');
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(pomXml, 'application/xml');

            const properties = xmlDoc.getElementsByTagName('properties')[0];
            console.log(properties)
            properties.innerHTML = `<java.version>17</java.version>` + "\n" +
                `<finalName>${appName}</finalName>` + "\n" +
                `<directory>/var/data</directory>`

            // Aquí puedes hacer las modificaciones necesarias al pom.xml
            const dependencies = xmlDoc.getElementsByTagName('dependencies')[0];
            // https://stackoverflow.com/questions/13220095/remove-unwanted-empty-xmlns-attribute-added-by-appendchild
            let newDependency = xmlDoc.createElementNS(dependencies.namespaceURI, 'dependency');
            newDependency.innerHTML = `
                <groupId>org.springdoc</groupId>
                <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
                <version>2.3.0</version>
            `;
            dependencies.appendChild(newDependency);

            newDependency = xmlDoc.createElementNS(dependencies.namespaceURI, 'dependency');
            newDependency.innerHTML = `
                <groupId>javax.validation</groupId>
                <artifactId>validation-api</artifactId>
                <version>2.0.1.Final</version>
            `;
            dependencies.appendChild(newDependency);

            newDependency = xmlDoc.createElementNS(dependencies.namespaceURI, 'dependency');
            newDependency.innerHTML = `
                <groupId>org.openapitools</groupId>
                <artifactId>jackson-databind-nullable</artifactId>
                <version>0.2.6</version>
            `;
            dependencies.appendChild(newDependency);

            newDependency = xmlDoc.createElementNS(dependencies.namespaceURI, 'dependency');
            newDependency.innerHTML = `
                <groupId>javax.annotation</groupId>
                <artifactId>javax.annotation-api</artifactId>
                <version>1.3.2</version>
            `;
            dependencies.appendChild(newDependency);

            newDependency = xmlDoc.createElementNS(dependencies.namespaceURI, 'dependency');
            newDependency.innerHTML = `
                <groupId>javax.servlet</groupId>
                <artifactId>servlet-api</artifactId>
                <version>2.5</version>
                <scope>provided</scope>
            `;
            dependencies.appendChild(newDependency);
            
            const plugins = xmlDoc.getElementsByTagName('plugins')[0];
            const newPlugin = xmlDoc.createElementNS(dependencies.namespaceURI, 'plugin');
            newPlugin.innerHTML = `
            	<groupId>org.openapitools</groupId>
				<artifactId>openapi-generator-maven-plugin</artifactId>
				<version>7.5.0</version>
				<executions>
					<execution>
						<goals>
							<goal>generate</goal>
						</goals>
						<configuration>
							<inputSpec>\${project.basedir}/src/main/resources/openapi.yml</inputSpec>
							<generatorName>spring</generatorName>
							<apiPackage>es.acaex.${appName}.api</apiPackage>
							<modelPackage>es.acaex.${appName}.dto</modelPackage>
							<supportingFilesToGenerate>
								ApiUtil.java
							</supportingFilesToGenerate>
							<configOptions>
								<delegatePattern>true</delegatePattern>
								<serializableModel>true</serializableModel>
							</configOptions>
						</configuration>
					</execution>
				</executions>` 
                plugins.appendChild(newPlugin);
                
            console.log(xmlDoc)
            // Serializar el XML modificado
            const serializer = new XMLSerializer();
            const newPomXml = serializer.serializeToString(xmlDoc);
            //console.log(newPomXml)
            //projectFolder.file('pom.xml', newPomXml);
            // No me funciona si lo hago aqui dentro
            //projectFolder.file(appName + 'pom.xml', newPomXml);
            //projectFolder.file(appName + 'poma.xml', newPomXml);
            return newPomXml;
        }

        async function addVsCodeFolder(projectFolder) {
            // Añadir archivos adicionales
            const vscodeFolder = projectFolder.folder('.vscode');
            vscodeFolder.file('tasks.json', JSON.stringify({
                "version": "2.0.0",
                "tasks": [
                    {
                        "label": "setup_environment",
                        "type": "shell",
                        "command": "./scripts/setup.bat",
                        "runOptions": {
                            "runOn": "folderOpen"
                        },
                        "problemMatcher": []
                    },
                    {
                        "label": "spring_boot_run",
                        "type": "shell",
                        "command": ".\\mvnw clean spring-boot:run",
                        "problemMatcher": []
                    },
                    {
                        "label": "bump_version",
                        "type": "shell",
                        "command": "if (Get-Command commit-and-tag-version -ErrorAction SilentlyContinue) { commit-and-tag-version --packageFiles pom.xml --bumpFiles pom.xml } else { Write-Host 'commit-and-tag-version no está instalado en el sistema.' }",
                        "problemMatcher": []
                    }
                ],
            }, null, 2));

            vscodeFolder.file('settings.json', JSON.stringify({
                "VsCodeTaskButtons.showCounter": false,
                "VsCodeTaskButtons.tasks": [
                    {
                        "label": "$(testing-run-icon) Spring-Boot:Run",
                        "task": "spring_boot_run",
                        "tooltip": "Ejecutar mvn spring-boot:run."
                    },
                    {
                        "label": "$(versions) Nueva Versión",
                        "task": "bump_version",
                        "tooltip": "Tarea para aumentar de version y etiquetar en git correctamente."
                    }
                ],
                "java.compile.nullAnalysis.mode": "automatic"
            }, null, 2));

            vscodeFolder.file('extensions.json', JSON.stringify({
                "recommendations": [
                    "vscjava.vscode-java-pack",
                    "vmware.vscode-boot-dev-pack",
                    "vscode-icons-team.vscode-icons",
                    "spencerwmiles.vscode-task-buttons"
                ]
            }, null, 2));
        }

        async function addScriptsFolder(projectFolder) {
            const scriptsFolder = projectFolder.folder('scripts');
            scriptsFolder.file('setup.bat', getSetupScriptContent(), { unixPermissions: "755" });
        }

        function getSetupScriptContent() {
            return `@echo off
setlocal

REM Comprueba si .env.properties existe
if not exist ".env.properties" (
    if exist ".env.properties.example" (
        echo Creando .env.properties a partir de .env.properties.example...
        copy ".env.properties.example" ".env.properties"
        if %errorlevel% neq 0 (
            echo Error al copiar .env.properties.example a .env.properties.
            exit /b 1
        )
    ) else (
        echo .env.properties.example no existe. No se puede crear .env.properties.
        exit /b 1
    )
)

REM Comprueba si el comando commit-and-tag-version está instalado
where commit-and-tag-version >nul 2>&1
if %errorlevel% neq 0 (
    REM Comprueba si Node.js está instalado
    where node >nul 2>&1
    if %errorlevel% neq 0 (
        echo Node.js no está instalado. Por favor, instala Node.js primero.
        exit /b 1
    ) else (
        echo Instalando commit-and-tag-version...
        npm install -g commit-and-tag-version
        if %errorlevel% neq 0 (
            echo Error al instalar commit-and-tag-version.
            exit /b 1
        )
    )
)

REM Comprueba si el directorio actual es un repositorio de git
if not exist ".git" (
    echo Inicializando un nuevo repositorio Git...
    git init
    if %errorlevel% neq 0 (
        echo Error al inicializar el repositorio Git.
        exit /b 1
    )
    git add -A
    git commit -am "feat: Acaex API Initializr - Inicio de Proyecto"
    if %errorlevel% neq 0 (
        echo Error al hacer el primer commit.
        exit /b 1
    )
    
    REM Crear la primera versión
    echo Creando la primera versión con commit-and-tag-version...
    commit-and-tag-version --packageFiles pom.xml --bumpFiles pom.xml
    if %errorlevel% neq 0 (
        echo Error al crear la primera versión.
        exit /b 1
    )
)

echo Setup completado.
endlocal
exit /b 0`

        }

        function getLogbackFileContent(appName) {
            return `<?xml version="1.0" encoding="UTF-8"?>
<configuration debug="false">

	<property resource="application.properties" />

	<appender name="Console" class="ch.qos.logback.core.ConsoleAppender">
		<layout class="ch.qos.logback.classic.PatternLayout">
			<Pattern>
				%-5p|%date{ISO8601}|%X{Slf4jMDCFilter.UUID}|%logger{0}|%m%ex%n
			</Pattern>
		</layout>
	</appender>


	<appender name="RollingFile"
		class="ch.qos.logback.core.rolling.RollingFileAppender">
		<file>\${app.path.logs}/app-logger.log</file>
		<encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
			<Pattern>
				%-5p|%date{ISO8601}|%X{Slf4jMDCFilter.UUID}|%logger{0}|%m%ex%n
			</Pattern>
		</encoder>

		<rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
			<fileNamePattern>\${app.path.logs}/${appName}-logger-%d{yyyy-MM-dd}.%i.log
			</fileNamePattern>
			<timeBasedFileNamingAndTriggeringPolicy
				class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
				<maxFileSize>10MB</maxFileSize>
			</timeBasedFileNamingAndTriggeringPolicy>
		</rollingPolicy>
	</appender>

	<logger name="org.springframework.web.method.HandlerMethod">
		<level value="TRACE" />
	</logger>


	<root level="info">
		<appender-ref ref="RollingFile" />
	</root>
</configuration>`
        }

        function getAppControllerFileContent(appName) {
            return `package es.acaex.${appName}.controllers;

            import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.Map;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.ClassPathResource;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping
public class AppController {
    
    @Value("\${app.env}")
    private String appEnv;

    @Value("\${app.version}")
    private String appVersion;

    @GetMapping
    public Map<String, String> info() {
        return new HashMap<String, String>() {{
            put("Entorno", appEnv);
            put("Version", appVersion);
        }};
    }

    @GetMapping(value = "openapi.yml", produces = "application/yaml;charset=UTF-8")
    public ResponseEntity<String> openapiYaml() {
        return ResponseEntity.ok(getOpenApiYaml());
    }

    private String getOpenApiYaml(){
        String contenido = "no Content";
        ClassPathResource resource = new ClassPathResource("openapi.yml");
        
        try {
            InputStream inputStream = resource.getInputStream();
            contenido = new BufferedReader(
                new InputStreamReader(inputStream, StandardCharsets.UTF_8))
                    .lines()
                    .collect(Collectors.joining("\\n")
            );
        } catch (IOException e) {
            contenido = "IOException";
        }
        return contenido;
    }

}`
        }

        function getEnvPropertiesExample() {
            return `# OpenAPI
springdoc.swagger-ui.url=/openapi.yml

# Base de Datos
spring.datasource.url=jdbc:h2:file:./database
spring.datasource.username=sa
spring.datasource.password=sa
spring.datasource.driver-class-name=org.h2.Driver
spring.jpa.hibernate.ddl-auto=create
spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
spring.jpa.hibernate.use-new-id-generator-mappings=false

# Jwt-Visado
jwt.environment=desarrollo
cors.allowedOrigins=http://localhost:*,http://127.0.0.1:*
visado.area=
visado.aplicacion=
visado.entorno=
# visado.profileFallback=

# Alfresco Config
# alfresco.usuario=
# alfresco.pass=
# alfresco.url.login=https://desgdcorp.gobex.pri/alfresco/api/-default-/public/cmis/versions/1.1/browser
# alfresco.url.site=/Sitios/NOMBREPROYECTO/documentLibrary
# spring.servlet.multipart.enabled=true
# spring.servlet.multipart.max-file-size=10MB
# spring.servlet.multipart.max-request-size=10MB

# Email Config
# spring.mail.host=envios.gobex.pri
# spring.mail.port=25
# spring.mail.username=
# spring.mail.password=
# spring.mail.defaultEncoding=UTF-8
# spring.mail.properties.mail.smtp.auth=true
# spring.mail.properties.mail.smtp.timeout=20000
# spring.mail.properties.mail.smtp.starttls.enable=false
# spring.mail.properties.mail.debug=true
`
        }

        function getOpenApiSpecificatioExample() {
    return `openapi: "3.0.0"
info:
  version: 0.1.0
  title: Peticiones de Gabinete de Prensa
servers:
  - url: http://localhost:8080
    description: Servidor local de desarrollo
tags:
  - name: consejerias
    description: Consejerías de la Junta de Extremadura
paths:
  /consejerias:
    get:
      summary: Listado de Consejerías en la aplicación
      operationId: listarConsejerias
      tags:
        - consejerias
      responses:
        "200":
          description: Listado completo de consejerías
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConsejeriasListResponse"
        "401":
          description: El usuario no está autenticado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NoAuthError"
        "403":
          description: El usuario no tiene permisos para acceder a este recurso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NoAuthError"
    post:
      summary: Crear una nueva consejeria
      operationId: crearConsejeria
      tags:
        - consejerias
      requestBody:
        description: Crear una nueva consejeria en la Aplicación
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConsejeriaCreate"
      responses:
        "201":
          description: Consejería creada correctamente
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConsejeriaSummaryResponse"
        "400":
          description: La información ofrecida es incorrecta
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorObject"
        "401":
          description: El usuario no está autenticado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NoAuthError"
        "403":
          description: El usuario no tiene permisos para acceder a este recurso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NoAuthError"
components:
  securitySchemes:
    JWT:
      type: http
      scheme: bearer
      bearerFormat: JWT
    Profile:
      type: apiKey
      in: header
      name: Profile
    User:
      type: apiKey
      in: header
      name: Jwt-User
  schemas:
    NoAuthError:
      description: Cuando el usuario no está logueado(AUTHenticate) o no tiene permisos (AUTHorization)
      type: object
      properties:
        code:
          type: integer
        error:
          type: string
    ErrorMessage:
      type: object
      properties:
        code:
          type: integer
        error:
          type: string
    ErrorObject:
      type: object
      properties:
        code:
          type: integer
        error:
          type: object
          additionalProperties: true
          example:
            nombre: "No puede ser nulo"
            descripcion: "Longitud debe estar entre 1 y 2048"
    ConsejeriasListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/ConsejeriaSummary"
    ConsejeriaSummary:
      type: object
      required:
        - id
        - dir3
        - nombre
      properties:
        id:
          type: integer
          format: int64
        dir3:
          type: string
        nombre:
          type: string
    ConsejeriaCreate:
      type: object
      required:
        - nombre
        - dir3
      properties:
        dir3:
          type: string
          minLength: 1
        nombre:
          type: string
          minLength: 1
          maxLength: 60
    ConsejeriaSummaryResponse:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/ConsejeriaSummary"
    `;
}
    </script>
</body>

</html>